# 代码分析任务的4个步骤

当你上传一个项目后,系统会自动执行4个步骤来分析代码:

---

## 📋 步骤概览

```
步骤0: 扫描代码文件 (0-25%)
  ↓
步骤1: 创建知识库 (25%)
  ↓
步骤2: 分析数据模型 (50%)
  ↓
步骤3: 生成文档 (75-100%)
```

---

## 🔍 步骤0: 扫描代码文件 (0-25%)

**目的**: 扫描项目中的所有代码文件,提取基本信息

**做什么**:
- 遍历项目目录,找出所有代码文件(.py, .js, .ts, .java等)
- 统计每个文件的代码行数
- 将文件信息保存到数据库(`file_analyses`表)

**输出**:
- 总文件数: 53个文件
- 成功扫描: 53个
- 失败: 0个
- 总代码行数: 12,345行

**前端显示**:
```
🔄 扫描文件中 (23/53)
[█████░░░░░░░░░░░░░░░░░░░] 11%
```

---

## 📚 步骤1: 创建知识库 (25%)

**目的**: 将代码转换为向量嵌入,创建RAG知识库

**做什么**:
- 读取所有代码文件的内容
- 使用AI模型将代码转换为向量(embeddings)
- 将向量存储到ChromaDB向量数据库
- 生成唯一的索引ID(如`index_1763208729997`)

**为什么需要**:
- 后续步骤需要通过语义搜索找到相关代码
- 例如:搜索"用户认证相关的代码"能找到所有相关文件

**输出**:
- 向量索引ID: `index_1763208729997`
- 向量数量: 1,234个代码片段

**前端显示**:
```
🔄 创建知识库 (步骤 1/4)
[██████░░░░░░░░░░░░░░░░░░] 25%
```

---

## 🧠 步骤2: 分析数据模型 (50%)

**目的**: 使用AI深度分析每个文件,提取代码结构

**做什么**:
- 对每个文件调用AI模型(如kimi-k2)
- 分析文件中的:
  - 类(Class)
  - 函数(Function)
  - 变量(Variable)
  - 导入依赖(Import)
  - 数据模型(Model)
- 将分析结果保存到数据库(`analysis_items`表)

**示例输出**:
```python
# 文件: services.py
分析项:
- Class: RepositoryService
  - Method: create_repository
  - Method: get_repository
- Class: AnalysisTaskService
  - Method: create_analysis_task
- Import: from models import Repository
```

**前端显示**:
```
🔄 分析数据模型 (步骤 2/4)
[████████████░░░░░░░░░░░░] 50%
```

---

## 📝 步骤3: 生成文档 (75-100%)

**目的**: 调用deepwiki服务生成项目README文档

**做什么**:
1. **打包代码**: 将项目打包成zip文件
2. **上传到deepwiki**: 通过HTTP上传zip
3. **调用文档生成API**: deepwiki使用AI生成README
4. **轮询状态**: 每5秒检查一次生成进度
5. **保存结果**: 将生成的README保存到数据库

**生成的文档包括**:
- 项目概述
- 技术栈
- 目录结构
- 核心功能说明
- API文档
- 架构图

**前端显示**:
```
🔄 生成文档 (步骤 3/4)
[██████████████████░░░░░░] 75%
```

**注意**: 
- 步骤3失败不影响整体任务
- 即使文档生成失败,你仍然可以查看步骤0-2的分析结果

---

## 🎯 完成后你可以做什么

### 1. 查看文件列表
- 所有代码文件及其统计信息
- 点击文件查看详细分析

### 2. 查看分析项
- 每个文件中的类、函数、变量
- 代码片段和说明

### 3. 语义搜索
- 使用自然语言搜索代码
- 例如:"用户登录的实现在哪里?"

### 4. 查看README文档
- AI生成的项目文档
- 项目概览和架构说明

---

## ⚙️ 技术架构

```
┌─────────────────┐
│  上传项目 (ZIP)  │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  步骤0: 扫描文件  │ ← Code-reader后端
│  (本地文件系统)   │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  步骤1: 创建知识库│ ← RAG服务(ChromaDB)
│  (向量嵌入)      │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  步骤2: 分析数据  │ ← AI模型(kimi-k2)
│  (代码结构分析)   │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│  步骤3: 生成文档  │ ← DeepWiki服务
│  (README生成)    │
└─────────────────┘
```

---

## 🚀 性能优化

- **步骤0**: 并发扫描文件,速度快
- **步骤1**: 批量处理向量嵌入
- **步骤2**: 最耗时(需要AI分析每个文件)
- **步骤3**: 异步生成,不阻塞主流程

---

## 💡 常见问题

**Q: 为什么步骤2这么慢?**  
A: 步骤2需要AI逐个分析每个文件,如果项目有100个文件,可能需要5-10分钟。

**Q: 步骤3失败了怎么办?**  
A: 步骤3失败不影响其他功能,你仍然可以查看文件分析结果和使用语义搜索。

**Q: 可以跳过某个步骤吗?**  
A: 不可以,步骤之间有依赖关系:
- 步骤1需要步骤0的文件列表
- 步骤2需要步骤1的向量索引
- 步骤3独立,但需要原始代码文件

**Q: 任务失败后可以重试吗?**  
A: 目前不支持重试,需要删除项目后重新上传。

